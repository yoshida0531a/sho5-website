<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X-post</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding-top: 20px;
      font-family: 'Quicksand', 'Noto Sans JP', sans-serif;
      background-color: #fff;
      color: #000;
      text-align: center;
    }
    .container {
      width: calc(100% - 40px);
      max-width: 800px;
      margin: 0 auto;
      text-align: left;
      position: relative;
    }

    /* Â∑¶‰∏ä„ÅÆÊàª„Çã„Éú„Çø„É≥ */
    .back-home {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 24px;
      text-decoration: none;
      color: #333;
      font-weight: bold;
      transition: color 0.3s;
    }
    .back-home:hover {
      color: #007bff;
    }

    /* „Éò„ÉÉ„ÉÄ„ÉºÁîªÂÉè */
    .header-image-container {
      text-align: center;
      margin: 40px 0 20px 0;
    }
    .header-image-container img {
      width: 100%;
      max-width: 250px;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: block;
      margin: 0 auto;
    }

    h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 20px 0;
      text-align: center;
    }

    /* Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ */
    .search-container {
      margin: 20px 0;
      text-align: center;
    }
    .search-box {
      width: 100%;
      max-width: 600px;
      padding: 12px 20px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      outline: none;
      transition: border-color 0.3s;
      font-family: 'Noto Sans JP', sans-serif;
    }
    .search-box:focus {
      border-color: #007bff;
    }
    .search-results-count {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    #tweets-container {
      margin-top: 20px;
    }
    .tweet-card {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 15px;
      background-color: #fcfcfc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .tweet-card.archived {
      display: none;
    }
    .tweet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
      flex-wrap: wrap;
    }
    .tweet-username {
      font-weight: 700;
      font-size: 15px;
      color: #007bff;
      margin-right: 10px;
      text-decoration: none;
    }
    .tweet-username:hover {
      text-decoration: underline;
    }
    .tweet-createdat {
      font-size: 12px;
      color: #777;
      flex-shrink: 0;
    }
    .tweet-text {
      font-size: 14px;
      line-height: 1.7;
      color: #222;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .tweet-link {
      display: inline-block;
      margin-top: 12px;
      font-size: 13px;
      color: #007bff;
      text-decoration: none;
    }
    .tweet-link:hover {
      text-decoration: underline;
    }
    
    /* „ÇÇ„Å£„Å®Ë™≠„ÇÄ„Éú„Çø„É≥ */
    .load-more-container {
      text-align: center;
      margin: 30px 0;
    }
    .load-more-btn {
      display: inline-block;
      padding: 12px 30px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .load-more-btn:hover {
      background-color: #0056b3;
    }
    .load-more-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #loading-message {
      text-align: center;
      padding: 30px;
      font-size: 16px;
      color: #888;
    }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .back-home {
        font-size: 20px;
      }
      h1 {
        margin-top: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Â∑¶‰∏ä„ÅÆÊàª„Çã„Éú„Çø„É≥ -->
    <a href="index.html" class="back-home">‚Üê</a>

    <!-- „Éò„ÉÉ„ÉÄ„ÉºÁîªÂÉè -->
    <div class="header-image-container">
      <img src="draft_image.png" alt="Èò™Á•û Ë∞∑Á´ØÂ∞Ü‰ºçÈÅ∏Êâã „Éâ„É©„Éï„Éà2‰ΩçÊåáÂêç">
    </div>

    <h1>X-post</h1>

    <!-- Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ -->
    <div class="search-container">
      <input type="text" id="searchBox" class="search-box" placeholder="üîç „Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢...">
      <div id="searchResultsCount" class="search-results-count"></div>
    </div>

    <div id="tweets-container">
      <p id="loading-message">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</p>
    </div>

    <!-- „ÇÇ„Å£„Å®Ë™≠„ÇÄ„Éú„Çø„É≥ -->
    <div class="load-more-container" id="loadMoreContainer" style="display: none;">
      <button id="loadMoreBtn" class="load-more-btn">‰ª•Ââç„ÇíË™≠„ÅøËæº„ÇÄ</button>
    </div>

    <br><br>
  </div>

  <script>
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let allTweets = [];
    let filteredTweets = [];
    let isSearching = false;
    let displayedArchivedTweets = 0;
    const ARCHIVED_TWEETS_PER_LOAD = 50;

    // XSSÂØæÁ≠ñ„ÅÆ„Åü„ÇÅ„ÅÆÁ∞°ÊòìHTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞
    function escapeHTML(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/[&<>"']/g, function(match) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[match];
      });
    }

    // Êó•‰ªò„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Åô„ÇãÈñ¢Êï∞
    function formatDate(dateString) {
      try {
        // Êßò„ÄÖ„Å™Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å´ÂØæÂøú
        let date;
        
        if (!dateString) {
          return 'Êó•‰ªò‰∏çÊòé';
        }

        // ISO 8601ÂΩ¢Âºè„ÇÑ„Åù„ÅÆ‰ªñ„ÅÆÊ®ôÊ∫ñÁöÑ„Å™Êó•‰ªòÊñáÂ≠óÂàó
        date = new Date(dateString);
        
        // ÁÑ°Âäπ„Å™Êó•‰ªò„ÅÆÂ†¥Âêà
        if (isNaN(date.getTime())) {
          return 'Êó•‰ªò‰∏çÊòé';
        }

        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${y}/${m}/${d} ${h}:${min}`;
      } catch (e) {
        console.error('Date format error:', e, dateString);
        return 'Êó•‰ªò‰∏çÊòé';
      }
    }

    // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíÂèñÂæóÔºà00:00:00Ôºâ
    function getTodayStart() {
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      return now;
    }

    // „ÉÑ„Ç§„Éº„Éà„Åå‰ªäÊó•„ÅÆ„ÇÇ„ÅÆ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    function isToday(dateString) {
      try {
        if (!dateString) return false;
        const tweetDate = new Date(dateString);
        if (isNaN(tweetDate.getTime())) return false;
        
        const today = getTodayStart();
        return tweetDate >= today;
      } catch (e) {
        return false;
      }
    }

    // „É¶„Éº„Ç∂„ÉºÂêç„Åã„Çâ@‰ªò„Åç„Å®„É™„É≥„ÇØ„ÇíÁîüÊàê
    function getUsernameHTML(tweet) {
      const username = tweet.username || tweet.user || 'X User';
      const cleanUsername = username.replace(/^@/, ''); // Êó¢Â≠ò„ÅÆ@„ÇíÂâäÈô§
      
      // URL„Åã„Çâ„É¶„Éº„Ç∂„ÉºÂêç„ÇíÊäΩÂá∫„Åß„Åç„ÇãÂ†¥Âêà
      if (tweet.url && tweet.url.includes('twitter.com/') || tweet.url && tweet.url.includes('x.com/')) {
        const match = tweet.url.match(/(?:twitter\.com|x\.com)\/([^\/\?]+)/);
        if (match && match[1] && match[1] !== 'i') {
          const extractedUsername = match[1];
          return `<a href="https://x.com/${escapeHTML(extractedUsername)}" target="_blank" rel="noopener noreferrer" class="tweet-username">@${escapeHTML(extractedUsername)}</a>`;
        }
      }
      
      // „Éá„Éï„Ç©„É´„Éà
      return `<span class="tweet-username">@${escapeHTML(cleanUsername)}</span>`;
    }

    // „ÉÑ„Ç§„Éº„Éà„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
    function displayTweets(tweets, showMoreArchived = false) {
      const container = document.getElementById('tweets-container');
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      
      if (!tweets || tweets.length === 0) {
        container.innerHTML = '<div class="no-results">Ë©≤ÂΩì„Åô„Çã„Éù„Çπ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>';
        loadMoreContainer.style.display = 'none';
        return;
      }

      const fragment = document.createDocumentFragment();
      let hasArchived = false;
      let todayTweets = [];
      let archivedTweets = [];

      // „ÉÑ„Ç§„Éº„Éà„ÇíÂΩìÊó•ÂàÜ„Å®„Ç¢„Éº„Ç´„Ç§„ÉñÂàÜ„Å´ÂàÜÈ°û
      tweets.forEach((tweet, index) => {
        const isTodayTweet = isToday(tweet.date || tweet.createdAt || tweet.created_at);
        if (isTodayTweet) {
          todayTweets.push(tweet);
        } else {
          archivedTweets.push(tweet);
        }
      });

      // ÂΩìÊó•ÂàÜ„ÇíË°®Á§∫
      todayTweets.forEach(tweet => {
        const card = document.createElement('div');
        card.className = 'tweet-card';
        
        const usernameHTML = getUsernameHTML(tweet);
        const dateStr = formatDate(tweet.date || tweet.createdAt || tweet.created_at);
        
        card.innerHTML = `
          <div class="tweet-header">
            ${usernameHTML}
            <span class="tweet-createdat">${escapeHTML(dateStr)}</span>
          </div>
          <div class="tweet-text">${escapeHTML(tweet.text || tweet.content || '')}</div>
          ${tweet.url ? `<a href="${escapeHTML(tweet.url)}" target="_blank" rel="noopener noreferrer" class="tweet-link">X„ÅßË¶ã„Çã</a>` : ''}
        `;
        
        fragment.appendChild(card);
      });

      // ÈÅéÂéªÂàÜ„ÇíË°®Á§∫ÔºàÊù°‰ª∂‰ªò„ÅçÔºâ
      if (showMoreArchived || isSearching) {
        const displayCount = showMoreArchived ? displayedArchivedTweets + ARCHIVED_TWEETS_PER_LOAD : archivedTweets.length;
        const tweetsToShow = archivedTweets.slice(0, displayCount);
        
        tweetsToShow.forEach(tweet => {
          const card = document.createElement('div');
          card.className = 'tweet-card';
          
          const usernameHTML = getUsernameHTML(tweet);
          const dateStr = formatDate(tweet.date || tweet.createdAt || tweet.created_at);
          
          card.innerHTML = `
            <div class="tweet-header">
              ${usernameHTML}
              <span class="tweet-createdat">${escapeHTML(dateStr)}</span>
            </div>
            <div class="tweet-text">${escapeHTML(tweet.text || tweet.content || '')}</div>
            ${tweet.url ? `<a href="${escapeHTML(tweet.url)}" target="_blank" rel="noopener noreferrer" class="tweet-link">X„ÅßË¶ã„Çã</a>` : ''}
          `;
          
          fragment.appendChild(card);
        });

        if (showMoreArchived) {
          displayedArchivedTweets = displayCount;
        }
      } else if (archivedTweets.length > 0) {
        hasArchived = true;
      }

      container.innerHTML = '';
      container.appendChild(fragment);

      // „ÇÇ„Å£„Å®Ë™≠„ÇÄ„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°
      if (hasArchived && !isSearching) {
        loadMoreContainer.style.display = 'block';
        const remainingArchived = archivedTweets.length - displayedArchivedTweets;
        if (remainingArchived <= 0) {
          loadMoreBtn.disabled = true;
          loadMoreBtn.textContent = '„Åô„Åπ„Å¶Ë°®Á§∫Ê∏à„Åø';
        } else {
          loadMoreBtn.disabled = false;
          loadMoreBtn.textContent = `‰ª•Ââç„ÇíË™≠„ÅøËæº„ÇÄ (ÊÆã„Çä${remainingArchived}‰ª∂)`;
        }
      } else {
        loadMoreContainer.style.display = 'none';
      }
    }

    // Ê§úÁ¥¢Ê©üËÉΩ
    function searchTweets(query) {
      if (!query || query.trim() === '') {
        isSearching = false;
        displayedArchivedTweets = 0;
        filteredTweets = allTweets;
        displayTweets(filteredTweets);
        document.getElementById('searchResultsCount').textContent = '';
        return;
      }

      isSearching = true;
      const lowerQuery = query.toLowerCase();
      filteredTweets = allTweets.filter(tweet => {
        const text = (tweet.text || tweet.content || '').toLowerCase();
        const username = (tweet.username || tweet.user || '').toLowerCase();
        return text.includes(lowerQuery) || username.includes(lowerQuery);
      });

      displayTweets(filteredTweets, false); // Ê§úÁ¥¢ÊôÇ„ÅØ„Åô„Åπ„Å¶Ë°®Á§∫
      document.getElementById('searchResultsCount').textContent = 
        `${filteredTweets.length}‰ª∂„ÅÆ„Éù„Çπ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü`;
    }

    // „ÇÇ„Å£„Å®Ë™≠„ÇÄ„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
    document.getElementById('loadMoreBtn').addEventListener('click', function() {
      displayedArchivedTweets += ARCHIVED_TWEETS_PER_LOAD;
      displayTweets(filteredTweets, true);
    });

    // Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Ç§„Éô„É≥„ÉàÔºà„É™„Ç¢„É´„Çø„Ç§„É†Ê§úÁ¥¢Ôºâ
    let searchTimeout;
    document.getElementById('searchBox').addEventListener('input', function(e) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchTweets(e.target.value);
      }, 300); // 300ms „ÅÆ„Éá„Éê„Ç¶„É≥„Çπ
    });

    // 7ÊôÇÊõ¥Êñ∞„Çπ„Ç±„Ç∏„É•„Éº„É´Ë®≠ÂÆö
    function schedule7AMUpdate() {
      const now = new Date();
      const next7AM = new Date();
      next7AM.setHours(7, 0, 0, 0);
      
      // 7ÊôÇ„ÇíÈÅé„Åé„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁøåÊó•„ÅÆ7ÊôÇ„Å´Ë®≠ÂÆö
      if (now >= next7AM) {
        next7AM.setDate(next7AM.getDate() + 1);
      }
      
      const msUntil7AM = next7AM.getTime() - now.getTime();
      
      console.log(`Ê¨°ÂõûÊõ¥Êñ∞: ${next7AM.toLocaleString()}Ôºà${Math.floor(msUntil7AM / 1000 / 60)}ÂàÜÂæåÔºâ`);
      
      setTimeout(() => {
        // 7ÊôÇ„Å´Âà∞ÈÅî„Åó„Åü„ÇâÊõ¥Êñ∞
        location.reload();
        
        // „Åù„ÅÆÂæå„ÅØÊØéÊó•7ÊôÇ„Å´Êõ¥Êñ∞
        setInterval(() => {
          location.reload();
        }, 24 * 60 * 60 * 1000);
      }, msUntil7AM);
    }

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éá„Éº„Çø„ÇíÂèñÂæó
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('tweets-container');
      const loadingMessage = document.getElementById('loading-message');

      fetch('draft-test.txt')
        .then(response => {
          if (!response.ok) {
            throw new Error(`„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (HTTP ${response.status})`);
          }
          return response.json(); 
        })
        .then(data => {
          if (!data || !data.tweets || data.tweets.length === 0) {
            loadingMessage.textContent = 'Ë°®Á§∫„Åß„Åç„Çã„Éù„Çπ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
            return;
          }

          allTweets = data.tweets;
          filteredTweets = allTweets;

          // Êó•‰ªòÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
          allTweets.sort((a, b) => {
            const dateA = new Date(a.date || a.createdAt || a.created_at || 0);
            const dateB = new Date(b.date || b.createdAt || b.created_at || 0);
            return dateB.getTime() - dateA.getTime();
          });

          // ÂΩìÊó•ÂàÜ„ÅÆ„ÅøÂàùÊúüË°®Á§∫
          displayedArchivedTweets = 0;
          displayTweets(allTweets, false);

          // 7ÊôÇÊõ¥Êñ∞„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË®≠ÂÆö
          schedule7AMUpdate();

        })
        .catch(error => {
          console.error('„Éù„Çπ„Éà„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:', error);
          loadingMessage.textContent = '„Éù„Çπ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇWeb„Çµ„Éº„Éê„Éº„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅ„Éï„Ç°„Ç§„É´Âêç(draft-test.txt)„ÅåÊ≠£„Åó„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          loadingMessage.style.color = 'red';
          loadingMessage.style.textAlign = 'left';
        });
    });
  </script>
</body>
</html>
