<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X New Post</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding-top: 20px;
      font-family: 'Quicksand', 'Noto Sans JP', sans-serif;
      background-color: #fff;
      color: #000;
      text-align: center;
    }
    .container {
      width: calc(100% - 40px);
      max-width: 800px;
      margin: 0 auto;
      text-align: left;
      position: relative;
    }

    /* å·¦ä¸Šã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
    .back-home {
      position: absolute;
      top: 0;
      left: 0;
      font-size: 24px;
      text-decoration: none;
      color: #333;
      font-weight: bold;
      transition: color 0.3s;
    }
    .back-home:hover {
      color: #007bff;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ */
    .header-image-container {
      text-align: center;
      margin: 40px 0 20px 0;
    }
    .header-image-container img {
      width: 100%;
      max-width: 250px;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: block;
      margin: 0 auto;
    }

    h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 20px 0;
      text-align: center;
    }

    /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
    .search-container {
      margin: 20px 0;
      text-align: center;
    }
    .search-box {
      width: 100%;
      max-width: 600px;
      padding: 12px 20px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      outline: none;
      transition: border-color 0.3s;
      font-family: 'Noto Sans JP', sans-serif;
    }
    .search-box:focus {
      border-color: #007bff;
    }
    .search-results-count {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    #tweets-container {
      margin-top: 20px;
    }
    .tweet-card {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 15px;
      background-color: #fcfcfc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .tweet-card.archived {
      display: none;
    }
    .tweet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
      flex-wrap: wrap;
    }
    .tweet-username {
      font-weight: 700;
      font-size: 15px;
      color: #007bff;
      margin-right: 10px;
      text-decoration: none;
    }
    .tweet-username:hover {
      text-decoration: underline;
    }
    .tweet-createdat {
      font-size: 12px;
      color: #777;
      flex-shrink: 0;
    }
    .tweet-text {
      font-size: 14px;
      line-height: 1.7;
      color: #222;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .tweet-link {
      display: inline-block;
      margin-top: 12px;
      font-size: 13px;
      color: #007bff;
      text-decoration: none;
    }
    .tweet-link:hover {
      text-decoration: underline;
    }
    
    /* ã‚‚ã£ã¨èª­ã‚€ãƒœã‚¿ãƒ³ */
    .load-more-container {
      text-align: center;
      margin: 30px 0;
    }
    .load-more-btn {
      display: inline-block;
      padding: 12px 30px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .load-more-btn:hover {
      background-color: #0056b3;
    }
    .load-more-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #loading-message {
      text-align: center;
      padding: 30px;
      font-size: 16px;
      color: #888;
    }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .back-home {
        font-size: 20px;
      }
      h1 {
        margin-top: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å·¦ä¸Šã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <a href="index.html" class="back-home">â†</a>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ -->
    <div class="header-image-container">
      <img src="draft_image.png" alt="é˜ªç¥ è°·ç«¯å°†ä¼é¸æ‰‹ ãƒ‰ãƒ©ãƒ•ãƒˆ2ä½æŒ‡å">
    </div>

    <h1>X New Post</h1>

    <!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
    <div class="search-container">
      <input type="text" id="searchBox" class="search-box" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
      <div id="searchResultsCount" class="search-results-count"></div>
    </div>

    <div id="tweets-container">
      <p id="loading-message">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <!-- ã‚‚ã£ã¨èª­ã‚€ãƒœã‚¿ãƒ³ -->
    <div class="load-more-container" id="loadMoreContainer" style="display: none;">
      <button id="loadMoreBtn" class="load-more-btn">ä»¥å‰ã‚’èª­ã¿è¾¼ã‚€</button>
    </div>

    <br><br>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let allTweets = [];
    let filteredTweets = [];
    let isSearching = false;
    let displayedArchivedTweets = 0;
    const ARCHIVED_TWEETS_PER_LOAD = 50;

    // XSSå¯¾ç­–ã®ãŸã‚ã®ç°¡æ˜“HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHTML(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/[&<>"']/g, function(match) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[match];
      });
    }

    // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
    function formatDate(dateString) {
      try {
        // æ§˜ã€…ãªæ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œ
        let date;
        
        if (!dateString) {
          return 'æ—¥ä»˜ä¸æ˜';
        }

        // ISO 8601å½¢å¼ã‚„ãã®ä»–ã®æ¨™æº–çš„ãªæ—¥ä»˜æ–‡å­—åˆ—
        date = new Date(dateString);
        
        // ç„¡åŠ¹ãªæ—¥ä»˜ã®å ´åˆ
        if (isNaN(date.getTime())) {
          return 'æ—¥ä»˜ä¸æ˜';
        }

        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${y}/${m}/${d} ${h}:${min}`;
      } catch (e) {
        console.error('Date format error:', e, dateString);
        return 'æ—¥ä»˜ä¸æ˜';
      }
    }

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆ00:00:00ï¼‰
    function getTodayStart() {
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      return now;
    }

    // æ˜¨æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆ00:00:00ï¼‰
    function getYesterdayStart() {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      yesterday.setHours(0, 0, 0, 0);
      return yesterday;
    }

    // ãƒ„ã‚¤ãƒ¼ãƒˆãŒä»Šæ—¥ã¾ãŸã¯æ˜¨æ—¥ã®ã‚‚ã®ã‹ãƒã‚§ãƒƒã‚¯
    function isTodayOrYesterday(dateString) {
      try {
        if (!dateString) return false;
        const tweetDate = new Date(dateString);
        if (isNaN(tweetDate.getTime())) return false;
        
        const yesterday = getYesterdayStart();
        return tweetDate >= yesterday;
      } catch (e) {
        return false;
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ã‚‰@ä»˜ãã¨ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆï¼ˆæ­£ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åä½¿ç”¨ï¼‰
    function getUsernameHTML(tweet) {
      // æ­£ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ä½¿ç”¨ï¼ˆJSONãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦ï¼‰
      let username = tweet.userName || tweet.username || tweet.user || tweet.author || tweet.screen_name || tweet.name;
      
      if (!username || username === 'X User' || username === 'user' || username === 'Unknown') {
        username = 'unknown_user';
      }
      
      // æ—¢å­˜ã®@ã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      const cleanUsername = String(username).replace(/^@/, '').trim();
      
      if (!cleanUsername) {
        return '<span class="tweet-username">@unknown_user</span>';
      }
      
      // ãƒªãƒ³ã‚¯ä»˜ãã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¿”ã™
      return `<a href="https://x.com/${escapeHTML(cleanUsername)}" target="_blank" rel="noopener noreferrer" class="tweet-username">@${escapeHTML(cleanUsername)}</a>`;
    }

    // ãƒ„ã‚¤ãƒ¼ãƒˆã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆï¼ˆæ­£ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åä½¿ç”¨ï¼‰
    function getTweetLink(tweet) {
      // æ­£ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ä½¿ç”¨ï¼ˆJSONãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦ï¼‰
      const tweetUrl = tweet.tweetUrl || tweet.url || tweet.link;
      
      if (tweetUrl) {
        // X/Twitter URLã®å½¢å¼ã‚’ç¢ºèªã—ã¦è¿”ã™
        if (tweetUrl.includes('twitter.com') || tweetUrl.includes('x.com')) {
          return tweetUrl.replace('twitter.com', 'x.com'); // x.comã«çµ±ä¸€
        }
      }
      
      return null;
    }

    // ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayTweets(tweets, showMoreArchived = false) {
      const container = document.getElementById('tweets-container');
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      
      if (!tweets || tweets.length === 0) {
        container.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹ãƒã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        loadMoreContainer.style.display = 'none';
        return;
      }

      const fragment = document.createDocumentFragment();
      let hasArchived = false;
      let recentTweets = [];
      let archivedTweets = [];

      // ãƒ„ã‚¤ãƒ¼ãƒˆã‚’æœ€è¿‘åˆ†ï¼ˆä»Šæ—¥+æ˜¨æ—¥ï¼‰ã¨ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–åˆ†ã«åˆ†é¡
      tweets.forEach((tweet, index) => {
        const isRecentTweet = isTodayOrYesterday(tweet.date || tweet.createdAt || tweet.created_at || tweet.timestamp);
        if (isRecentTweet) {
          recentTweets.push(tweet);
        } else {
          archivedTweets.push(tweet);
        }
      });

      // æœ€è¿‘åˆ†ï¼ˆä»Šæ—¥+æ˜¨æ—¥ï¼‰ã‚’è¡¨ç¤º
      recentTweets.forEach(tweet => {
        const card = document.createElement('div');
        card.className = 'tweet-card';
        
        const usernameHTML = getUsernameHTML(tweet);
        const dateStr = formatDate(tweet.date || tweet.createdAt || tweet.created_at || tweet.timestamp);
        const tweetLink = getTweetLink(tweet);
        const tweetText = tweet.text || tweet.content || tweet.full_text || tweet.message || '';
        
        card.innerHTML = `
          <div class="tweet-header">
            ${usernameHTML}
            <span class="tweet-createdat">${escapeHTML(dateStr)}</span>
          </div>
          <div class="tweet-text">${escapeHTML(tweetText)}</div>
          ${tweetLink ? `<a href="${escapeHTML(tweetLink)}" target="_blank" rel="noopener noreferrer" class="tweet-link">Xã§è¦‹ã‚‹ â†’</a>` : ''}
        `;
        
        fragment.appendChild(card);
      });

      // éå»åˆ†ã‚’è¡¨ç¤ºï¼ˆæ¡ä»¶ä»˜ãï¼‰
      if (showMoreArchived || isSearching) {
        const displayCount = showMoreArchived ? displayedArchivedTweets + ARCHIVED_TWEETS_PER_LOAD : archivedTweets.length;
        const tweetsToShow = archivedTweets.slice(0, displayCount);
        
        tweetsToShow.forEach(tweet => {
          const card = document.createElement('div');
          card.className = 'tweet-card';
          
          const usernameHTML = getUsernameHTML(tweet);
          const dateStr = formatDate(tweet.date || tweet.createdAt || tweet.created_at || tweet.timestamp);
          const tweetLink = getTweetLink(tweet);
          const tweetText = tweet.text || tweet.content || tweet.full_text || tweet.message || '';
          
          card.innerHTML = `
            <div class="tweet-header">
              ${usernameHTML}
              <span class="tweet-createdat">${escapeHTML(dateStr)}</span>
            </div>
            <div class="tweet-text">${escapeHTML(tweetText)}</div>
            ${tweetLink ? `<a href="${escapeHTML(tweetLink)}" target="_blank" rel="noopener noreferrer" class="tweet-link">Xã§è¦‹ã‚‹ â†’</a>` : ''}
          `;
          
          fragment.appendChild(card);
        });

        if (showMoreArchived) {
          displayedArchivedTweets = displayCount;
        }
      } else if (archivedTweets.length > 0) {
        hasArchived = true;
      }

      container.innerHTML = '';
      container.appendChild(fragment);

      // ã‚‚ã£ã¨èª­ã‚€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
      if (hasArchived && !isSearching) {
        loadMoreContainer.style.display = 'block';
        const remainingArchived = archivedTweets.length - displayedArchivedTweets;
        if (remainingArchived <= 0) {
          loadMoreBtn.disabled = true;
          loadMoreBtn.textContent = 'ã™ã¹ã¦è¡¨ç¤ºæ¸ˆã¿';
        } else {
          loadMoreBtn.disabled = false;
          loadMoreBtn.textContent = `ä»¥å‰ã‚’èª­ã¿è¾¼ã‚€ (æ®‹ã‚Š${remainingArchived}ä»¶)`;
        }
      } else {
        loadMoreContainer.style.display = 'none';
      }
    }

    // æ¤œç´¢æ©Ÿèƒ½
    function searchTweets(query) {
      if (!query || query.trim() === '') {
        isSearching = false;
        displayedArchivedTweets = 0;
        filteredTweets = allTweets;
        displayTweets(filteredTweets);
        document.getElementById('searchResultsCount').textContent = '';
        return;
      }

      isSearching = true;
      const lowerQuery = query.toLowerCase();
      filteredTweets = allTweets.filter(tweet => {
        const text = (tweet.text || tweet.content || tweet.full_text || tweet.message || '').toLowerCase();
        const username = (tweet.userName || tweet.username || tweet.user || tweet.author || '').toLowerCase();
        return text.includes(lowerQuery) || username.includes(lowerQuery);
      });

      displayTweets(filteredTweets, false); // æ¤œç´¢æ™‚ã¯ã™ã¹ã¦è¡¨ç¤º
      document.getElementById('searchResultsCount').textContent = 
        `${filteredTweets.length}ä»¶ã®ãƒã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
    }

    // ã‚‚ã£ã¨èª­ã‚€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('loadMoreBtn').addEventListener('click', function() {
      displayedArchivedTweets += ARCHIVED_TWEETS_PER_LOAD;
      displayTweets(filteredTweets, true);
    });

    // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ï¼‰
    let searchTimeout;
    document.getElementById('searchBox').addEventListener('input', function(e) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchTweets(e.target.value);
      }, 300); // 300ms ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('tweets-container');
      const loadingMessage = document.getElementById('loading-message');

      fetch('draft-test.txt')
        .then(response => {
          if (!response.ok) {
            throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP ${response.status})`);
          }
          return response.json(); 
        })
        .then(data => {
          // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ãƒ‡ãƒãƒƒã‚°
          console.log('èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:', data);
          
          // æ§˜ã€…ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¯¾å¿œ
          let tweets = [];
          if (data.tweets) {
            tweets = data.tweets;
          } else if (Array.isArray(data)) {
            tweets = data;
          } else if (data.data && Array.isArray(data.data)) {
            tweets = data.data;
          }

          if (!tweets || tweets.length === 0) {
            loadingMessage.textContent = 'è¡¨ç¤ºã§ãã‚‹ãƒã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
            return;
          }

          // å„ãƒ„ã‚¤ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚‚ãƒ­ã‚°å‡ºåŠ›
          console.log('æœ€åˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã®ä¾‹:', tweets[0]);

          allTweets = tweets;
          filteredTweets = allTweets;

          // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
          allTweets.sort((a, b) => {
            const dateA = new Date(a.date || a.createdAt || a.created_at || a.timestamp || 0);
            const dateB = new Date(b.date || b.createdAt || b.created_at || b.timestamp || 0);
            return dateB.getTime() - dateA.getTime();
          });

          // ä»Šæ—¥+æ˜¨æ—¥åˆ†ã®ã¿åˆæœŸè¡¨ç¤º
          displayedArchivedTweets = 0;
          displayTweets(allTweets, false);

        })
        .catch(error => {
          console.error('ãƒã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
          loadingMessage.textContent = 'ãƒã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Webã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«å(draft-test.txt)ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          loadingMessage.style.color = 'red';
          loadingMessage.style.textAlign = 'left';
        });
    });
  </script>
</body>
</html>
