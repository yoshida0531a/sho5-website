name: Filter YouTube by Subscribers

on:
  workflow_dispatch:
    inputs:
      min_subscribers:
        description: 'Minimum subscriber count (default: 100)'
        required: false
        default: '100'
        type: number
      dry_run:
        description: 'Dry run mode (preview only, no changes)'
        required: false
        default: false
        type: boolean

jobs:
  filter-youtube:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run YouTube filter script
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          MIN_SUBSCRIBERS: ${{ github.event.inputs.min_subscribers || '100' }}
        run: |
          if [ -z "$YOUTUBE_API_KEY" ]; then
            echo "âŒ Error: YOUTUBE_API_KEY secret is not set."
            echo "Please add your YouTube API key as a repository secret named 'YOUTUBE_API_KEY'"
            echo ""
            echo "æ‰‹é †:"
            echo "1. Settings > Secrets and variables > Actions"
            echo "2. 'New repository secret' ã‚’ã‚¯ãƒªãƒƒã‚¯"
            echo "3. Name: YOUTUBE_API_KEY"
            echo "4. Secret: ã‚ãªãŸã®YouTube API Key"
            exit 1
          fi
          
          echo "ğŸ¬ YouTube-data.txt ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™..."
          echo "ğŸ“Š æœ€å°ç™»éŒ²è€…æ•°: $MIN_SUBSCRIBERS"
          
          node scripts/filter-youtube-by-subscribers.js

      - name: Show results
        run: |
          if [ -f "YouTube-data.txt.backup" ]; then
            BEFORE=$(cat YouTube-data.txt.backup | grep -c '"url"' || echo "0")
            AFTER=$(cat YouTube-data.txt | grep -c '"url"' || echo "0")
            REMOVED=$((BEFORE - AFTER))
            
            echo "ğŸ“ˆ çµæœã‚µãƒãƒªãƒ¼:"
            echo "   å‡¦ç†å‰: $BEFORE ä»¶"
            echo "   å‡¦ç†å¾Œ: $AFTER ä»¶"
            echo "   å‰Šé™¤: $REMOVED ä»¶"
          fi

      - name: Commit changes
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes
          if git diff --quiet YouTube-data.txt; then
            echo "âœ… å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆå‰Šé™¤å¯¾è±¡ã®å‹•ç”»ãªã—ï¼‰"
          else
            git add YouTube-data.txt
            git commit -m "chore: Filter YouTube data by subscriber count (min: ${{ github.event.inputs.min_subscribers }})"
            git push
            echo "âœ… YouTube-data.txt ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          fi

      - name: Dry run notice
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ğŸ” ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰: å¤‰æ›´ã¯ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
          echo "å®Ÿéš›ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨ã™ã‚‹ã«ã¯ã€dry_run ã‚’ false ã«ã—ã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„"
